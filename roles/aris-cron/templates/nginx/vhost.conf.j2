server {
  listen 80;
  server_name {{ item.key }}.{{ base_domain }};

  # Tell Nginx and Passenger where your app's 'public' directory is
  root /var/apps/{{ item.key }}/public;

  # Enable gzip and proper cache settings for assets
  location ^~ /assets/ {
    gzip_static on;
    expires max;
    add_header Cache-Control public;
  }

  # TODO: Disable all caching since it seem to lead to issues with. Need to
  # investigate further.
  location / {
    etag off;
    add_header Cache-Control no-cache;
  }

  # Include all user-app-specific conf files
  include /var/apps/{{ item.key }}/nginx/extras/*.conf;

  access_log /var/apps/{{ item.key }}/logs/nginx-access.log;
  error_log  /var/apps/{{ item.key }}/logs/nginx-error.log;

  # Passenger config
  passenger_enabled on;
  passenger_app_root /var/apps/{{ item.key }}/code;
  passenger_ruby /opt/rubies/{{ chruby_ruby_version }}/bin/ruby;
}
